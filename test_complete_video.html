<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Video Analysis Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .video-section, .analysis-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        video {
            width: 100%;
            max-width: 400px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .controls {
            margin: 15px 0;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        .start { background-color: #4CAF50; color: white; }
        .stop { background-color: #f44336; color: white; }
        .test { background-color: #2196F3; color: white; }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .metric-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .insights {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .frame-info {
            font-size: 12px;
            color: #666;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üé• Complete Video Analysis Test</h1>
    
    <div class="status info" id="status">
        Ready to test complete video analysis system
    </div>
    
    <div class="container">
        <div class="video-section">
            <h2>üìπ Video Input</h2>
            <video id="videoElement" autoplay muted playsinline></video>
            
            <div class="controls">
                <button class="test" onclick="initializeCamera()">üì∑ Initialize Camera</button>
                <button class="test" onclick="connectSocket()">üîå Connect Socket</button>
                <button class="start" onclick="startCompleteAnalysis()">‚ñ∂Ô∏è Start Analysis</button>
                <button class="stop" onclick="stopCompleteAnalysis()">‚èπÔ∏è Stop Analysis</button>
            </div>
            
            <div class="frame-info" id="frameInfo">
                No frames sent yet
            </div>
        </div>
        
        <div class="analysis-section">
            <h2>üìä Real-time Analysis</h2>
            
            <div class="metrics" id="metrics">
                <div class="metric-card">
                    <div class="metric-title">üëã Hands Detected</div>
                    <div class="metric-value" id="handsCount">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">üòä Dominant Emotion</div>
                    <div class="metric-value" id="emotion">None</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">üßç Pose Detected</div>
                    <div class="metric-value" id="poseStatus">No</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">üìà Overall Score</div>
                    <div class="metric-value" id="overallScore">0%</div>
                </div>
            </div>
            
            <div class="insights" id="insights" style="display: none;">
                <h3>üí° AI Insights</h3>
                <div id="insightsContent"></div>
            </div>
        </div>
    </div>
    
    <div class="log" id="log"></div>
    
    <button onclick="clearLog()" style="margin: 10px 0;">üóëÔ∏è Clear Log</button>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket = null;
        let videoStream = null;
        let isAnalyzing = false;
        let frameInterval = null;
        let sessionId = 'complete_test_' + Date.now();
        let frameCount = 0;
        let lastAnalysisUpdate = null;

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#6c757d';
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateMetrics(analysis) {
            if (!analysis) return;

            // Update hand detection
            if (analysis.hand_analysis) {
                document.getElementById('handsCount').textContent = analysis.hand_analysis.hands_detected || 0;
            }

            // Update emotion
            if (analysis.emotion_analysis) {
                document.getElementById('emotion').textContent = analysis.emotion_analysis.dominant_emotion || 'None';
            }

            // Update pose
            if (analysis.pose_analysis) {
                document.getElementById('poseStatus').textContent = analysis.pose_analysis.pose_detected ? 'Yes' : 'No';
            }

            // Update overall score
            if (analysis.overall_scores) {
                const score = Math.round((analysis.overall_scores.overall_score || 0) * 100);
                document.getElementById('overallScore').textContent = score + '%';
            }
        }

        function showInsights(insights) {
            const insightsElement = document.getElementById('insights');
            const contentElement = document.getElementById('insightsContent');
            
            if (insights && insights.length > 0) {
                contentElement.innerHTML = insights.map(insight => `<p>‚Ä¢ ${insight}</p>`).join('');
                insightsElement.style.display = 'block';
            }
        }

        async function initializeCamera() {
            try {
                log('üîÑ Initializing camera...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 },
                        facingMode: 'user'
                    } 
                });
                
                const video = document.getElementById('videoElement');
                video.srcObject = stream;
                videoStream = stream;
                
                log('‚úÖ Camera initialized successfully', 'success');
                updateStatus('Camera ready', 'success');
                
            } catch (error) {
                log(`‚ùå Camera initialization failed: ${error.message}`, 'error');
                updateStatus('Camera access denied', 'error');
            }
        }

        function connectSocket() {
            try {
                log('üîÑ Connecting to server...', 'info');
                
                // Connect to local server
                socket = io('http://127.0.0.1:8080', {
                    transports: ['websocket', 'polling']
                });

                socket.on('connect', () => {
                    log('‚úÖ Socket connected successfully', 'success');
                    updateStatus('Connected to server', 'success');
                });

                socket.on('disconnect', () => {
                    log('‚ùå Socket disconnected', 'error');
                    updateStatus('Disconnected from server', 'error');
                });

                socket.on('video_analysis_started', (data) => {
                    log(`‚úÖ Video analysis started: ${data.analyzer_type} analyzer`, 'success');
                    updateStatus('Video analysis active', 'success');
                });

                socket.on('video_analysis_update', (data) => {
                    log(`üìä Video analysis update received`, 'success');
                    lastAnalysisUpdate = data;
                    
                    if (data.analysis) {
                        updateMetrics(data.analysis);
                        log(`   - Hands: ${data.analysis.hand_analysis?.hands_detected || 0}`, 'info');
                        log(`   - Emotion: ${data.analysis.emotion_analysis?.dominant_emotion || 'none'}`, 'info');
                        log(`   - Pose: ${data.analysis.pose_analysis?.pose_detected ? 'detected' : 'not detected'}`, 'info');
                    }
                });

                socket.on('video_insights', (data) => {
                    log(`üí° Video insights received: ${data.insights?.length || 0} insights`, 'success');
                    if (data.insights) {
                        showInsights(data.insights);
                    }
                });

                socket.on('video_error', (data) => {
                    log(`‚ùå Video error: ${data.error}`, 'error');
                    updateStatus('Video analysis error', 'error');
                });

                socket.on('video_analysis_stopped', (data) => {
                    log(`‚èπÔ∏è Video analysis stopped`, 'info');
                    updateStatus('Video analysis stopped', 'info');
                });

            } catch (error) {
                log(`‚ùå Socket connection failed: ${error.message}`, 'error');
                updateStatus('Connection failed', 'error');
            }
        }

        function startCompleteAnalysis() {
            if (!socket || !socket.connected) {
                log('‚ùå Socket not connected. Connect to server first.', 'error');
                updateStatus('Not connected to server', 'error');
                return;
            }

            if (!videoStream) {
                log('‚ùå Camera not ready. Initialize camera first.', 'error');
                updateStatus('Camera not ready', 'error');
                return;
            }

            log('üöÄ Starting complete video analysis...', 'info');
            
            // Start video analysis on server
            socket.emit('start_video_analysis', { session_id: sessionId });
            
            // Start sending frames every 1 second
            frameInterval = setInterval(captureAndSendFrame, 1000);
            isAnalyzing = true;
            frameCount = 0;
            
            updateStatus('Video analysis running', 'success');
        }

        function stopCompleteAnalysis() {
            if (!socket || !socket.connected) {
                log('‚ùå Socket not connected', 'error');
                return;
            }

            log('‚èπÔ∏è Stopping video analysis...', 'info');
            
            // Stop sending frames
            if (frameInterval) {
                clearInterval(frameInterval);
                frameInterval = null;
            }
            
            // Stop video analysis on server
            socket.emit('stop_video_analysis', { session_id: sessionId });
            isAnalyzing = false;
            
            updateStatus('Video analysis stopped', 'info');
            log(`üìä Total frames sent: ${frameCount}`, 'info');
        }

        function captureAndSendFrame() {
            if (!isAnalyzing || !videoStream || !socket || !socket.connected) return;

            try {
                const video = document.getElementById('videoElement');
                
                // Check if video is ready
                if (video.readyState < 2) {
                    log('‚ö†Ô∏è Video not ready, skipping frame', 'warning');
                    return;
                }
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size (optimize for analysis)
                canvas.width = 640;
                canvas.height = 480;
                
                // Draw current video frame
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convert to base64 JPEG
                const frameData = canvas.toDataURL('image/jpeg', 0.8);
                
                // Send frame to server
                socket.emit('video_frame', {
                    session_id: sessionId,
                    frame_data: frameData
                });
                
                frameCount++;
                
                // Update frame info
                document.getElementById('frameInfo').textContent = 
                    `Frames sent: ${frameCount} | Last: ${new Date().toLocaleTimeString()}`;
                
                log(`üì∏ Frame ${frameCount} sent (${Math.round(frameData.length / 1024)}KB)`, 'info');
                
            } catch (error) {
                log(`‚ùå Error capturing frame: ${error.message}`, 'error');
            }
        }

        // Initialize on page load
        window.onload = function() {
            log('üé¨ Complete video analysis test loaded', 'info');
            log(`üìã Session ID: ${sessionId}`, 'info');
            log('üìù Instructions:', 'info');
            log('   1. Click "Initialize Camera" to access your camera', 'info');
            log('   2. Click "Connect Socket" to connect to the server', 'info');
            log('   3. Click "Start Analysis" to begin video analysis', 'info');
            log('   4. Make gestures and expressions to see real-time analysis', 'info');
            log('   5. Click "Stop Analysis" when done', 'info');
        };

        // Cleanup on page unload
        window.onbeforeunload = function() {
            if (isAnalyzing) {
                stopCompleteAnalysis();
            }
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        };
    </script>
</body>
</html>